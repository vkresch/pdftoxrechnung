<?xml version="1.0" encoding="UTF-8"?>
<ubl:Invoice xmlns:ubl="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2" xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2" xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2">
    <cbc:CustomizationID>urn:cen.eu:en16931:2017#compliant#urn:xeinkauf.de:kosit:xrechnung_3.0</cbc:CustomizationID>
    <cbc:ProfileID>urn:fdc:peppol.eu:2017:poacc:billing:01:1.0</cbc:ProfileID>
    <cbc:ID>{{ data.invoiceNumber }}</cbc:ID>
    <cbc:IssueDate>{{ data.invoiceDate }}</cbc:IssueDate>
    {% if data.dueDate != "" -%}
    <cbc:DueDate>{{ data.dueDate }}</cbc:DueDate>
    {% endif -%}
    <cbc:InvoiceTypeCode>380</cbc:InvoiceTypeCode>
    <cbc:Note>{{ data.note }}</cbc:Note>
    <cbc:DocumentCurrencyCode>{{ data.currencyCode }}</cbc:DocumentCurrencyCode>
    <cbc:BuyerReference>{{ data.leitwegID }}</cbc:BuyerReference>
    {% if data.purchaseOrderReference != "" -%}
    <cac:OrderReference>
        <cbc:ID>{{ data.purchaseOrderReference }}</cbc:ID>
		{% if data.customerSalesOrderNumber != "" -%}<cbc:SalesOrderID>{{ data.customerSalesOrderNumber }}</cbc:SalesOrderID>{% endif -%}
	</cac:OrderReference>
    {% endif -%}
    {% if data.contractDocumentReference != "" -%}
    <cac:ContractDocumentReference>
		<cbc:ID>{{ data.contractDocumentReference }}</cbc:ID>
	</cac:ContractDocumentReference>
    {% endif -%}
    <cac:AccountingSupplierParty>
        <cac:Party>
            <cbc:EndpointID schemeID="EM">{{ data.ownContactEmail }}</cbc:EndpointID>
            {% if data.ownCompanyName != "" -%}
            <cac:PartyName>
                <cbc:Name>{{ data.ownCompanyName }}</cbc:Name>
            </cac:PartyName>
            {% endif -%}
            <cac:PostalAddress>
                {% if data.ownStreetname != "" -%}<cbc:StreetName>{{ data.ownStreetname }}</cbc:StreetName>{% endif %}
                {% if data.ownCityname != "" -%}<cbc:CityName>{{ data.ownCityname }}</cbc:CityName>{% endif %}
                {% if data.ownPostalCode != "" -%}<cbc:PostalZone>{{ data.ownPostalCode }}</cbc:PostalZone>{% endif %}
                <cac:Country>
                    <cbc:IdentificationCode>DE</cbc:IdentificationCode>
                </cac:Country>
            </cac:PostalAddress>
            <cac:PartyTaxScheme>
                <cbc:CompanyID>{{ data.ownCompanyID }}</cbc:CompanyID>
                <cac:TaxScheme>
                    <cbc:ID>VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:PartyTaxScheme>
            <cac:PartyLegalEntity>
                <cbc:RegistrationName>{{ data.ownCompanyName }}</cbc:RegistrationName>
                <cbc:CompanyID>{{ data.ownHraNo }}</cbc:CompanyID>
                <cbc:CompanyLegalForm>{{ data.ownLegalForm }}</cbc:CompanyLegalForm>
            </cac:PartyLegalEntity>
            <cac:Contact>
                <cbc:Name>{{ data.ownContactName }}</cbc:Name>
                <cbc:Telephone>{{ data.ownContactPhone }}</cbc:Telephone>
                <cbc:ElectronicMail>{{ data.ownContactEmail }}</cbc:ElectronicMail>
            </cac:Contact>
        </cac:Party>
    </cac:AccountingSupplierParty>
    <cac:AccountingCustomerParty>
        <cac:Party>
            <cbc:EndpointID schemeID="EM">{{ data.customerID }}</cbc:EndpointID>
            {% if data.customerID != "" -%}
            <cac:PartyIdentification>
                <cbc:ID>{{ data.customerID }}</cbc:ID>
            </cac:PartyIdentification>
            {% endif -%}
            {% if data.customerCompanyName != "" -%}
            <cac:PartyName>
                <cbc:Name>{{ data.customerCompanyName }}</cbc:Name>
            </cac:PartyName>
            {% endif -%}
            <cac:PostalAddress>
                <cbc:StreetName>{{ data.customerStreetname }}</cbc:StreetName>
                <cbc:CityName>{{ data.customerCityname }}</cbc:CityName>
                <cbc:PostalZone>{{ data.customerPostalZone }}</cbc:PostalZone>
                <cac:Country>
                    <cbc:IdentificationCode>DE</cbc:IdentificationCode>
                </cac:Country>
            </cac:PostalAddress>
            {% if data.customerCompanyName != "" -%}
            <cac:PartyLegalEntity>
                <cbc:RegistrationName>{{ data.customerCompanyName }}</cbc:RegistrationName>
            </cac:PartyLegalEntity>
            {% endif -%}
            {% if data.customerContactName != "" -%}
            <cac:Contact>
                <cbc:Name>{{ data.customerContactName }}</cbc:Name>
            </cac:Contact>
            {% endif -%}
        </cac:Party>
    </cac:AccountingCustomerParty>
    {% if data.deliveryDate != "" -%}
    <cac:Delivery>
        {% if data.deliveryDate != "" -%}<cbc:ActualDeliveryDate>{{ data.deliveryDate }}</cbc:ActualDeliveryDate>{% endif %}
        {% if data.locationID != "" -%}
		<cac:DeliveryLocation>
			<cbc:ID>{{ data.locationID }}</cbc:ID>
			<cac:Address>
				{% if data.deliveryStreetName != "" -%}<cbc:StreetName>{{ data.deliveryStreetName }}</cbc:StreetName>{% endif %}
				{% if data.deliveryCityName != "" -%}<cbc:CityName>{{ data.deliveryCityName }}</cbc:CityName>{% endif %}
				{% if data.deliveryPostalZone != "" -%}<cbc:PostalZone>{{ data.deliveryPostalZone }}</cbc:PostalZone>{% endif %}
				{% if data.deliveryRegion != "" -%}<cbc:CountrySubentity>{{ data.deliveryRegion }}</cbc:CountrySubentity>{% endif %}
                {% if data.deliveryCountryCode != "" -%}
				<cac:Country>
					<cbc:IdentificationCode>{{ data.deliveryCountryCode }}</cbc:IdentificationCode>
				</cac:Country>
                {% endif -%}
			</cac:Address>
		</cac:DeliveryLocation>
        {% if data.deliveryReceiptName != "" -%}
		<cac:DeliveryParty>
			<cac:PartyName>
				<cbc:Name>{{ data.deliveryReceiptName }}</cbc:Name>
			</cac:PartyName>
		</cac:DeliveryParty>
        {% endif -%}
        {% endif -%}
	</cac:Delivery>
    {% endif -%}
    <cac:PaymentMeans>
        {% if data.paymentMeansCode != "" -%}<cbc:PaymentMeansCode>{{ data.paymentMeansCode }}</cbc:PaymentMeansCode>{% endif %}
        {% if data.invoiceNumber != "" -%}<cbc:PaymentID>{{ data.invoiceNumber }}</cbc:PaymentID>{% endif %}
        <cac:PayeeFinancialAccount>
            {% if data.ownIban != "" -%}<cbc:ID>{{ data.ownIban }}</cbc:ID>{% endif %}
            {% if data.ownCompanyName != "" -%}<cbc:Name>{{ data.ownCompanyName }}</cbc:Name>{% endif %}
        </cac:PayeeFinancialAccount>
    </cac:PaymentMeans>
    <cac:PaymentTerms>
        <cbc:Note>{{ data.note }}</cbc:Note>
    </cac:PaymentTerms>
    {% for charge in data.charges -%}
    <cac:AllowanceCharge>
		<cbc:ChargeIndicator>true</cbc:ChargeIndicator>
		{% if charge.reason != "" -%}<cbc:AllowanceChargeReason>{{ charge.reason }}</cbc:AllowanceChargeReason>{% endif -%}
		<cbc:MultiplierFactorNumeric>{{ charge.percent }}</cbc:MultiplierFactorNumeric>
		<cbc:Amount currencyID="{{ data.currencyCode }}">{{ charge.amount }}</cbc:Amount>
		<cbc:BaseAmount currencyID="{{ data.currencyCode }}">{{ charge.basis_amount }}</cbc:BaseAmount>
		<cac:TaxCategory>
			<cbc:ID>{{ charge.tax_category }}</cbc:ID>
			<cbc:Percent>{{ charge.tax_rate }}</cbc:Percent>
			<cac:TaxScheme>
				<cbc:ID>VAT</cbc:ID>
			</cac:TaxScheme>
		</cac:TaxCategory>
	</cac:AllowanceCharge>
    {% endfor -%}
    {% for allowance in data.allowances -%}
	<cac:AllowanceCharge>
		<cbc:ChargeIndicator>false</cbc:ChargeIndicator>
		{% if allowance.reason != "" -%}<cbc:AllowanceChargeReason>{{ allowance.reason }}</cbc:AllowanceChargeReason>{% endif -%}
		<cbc:MultiplierFactorNumeric>{{ allowance.percent }}</cbc:MultiplierFactorNumeric>
		<cbc:Amount currencyID="{{ data.currencyCode }}">{{ allowance.amount }}</cbc:Amount>
		<cbc:BaseAmount currencyID="{{ data.currencyCode }}">{{ allowance.basis_amount }}</cbc:BaseAmount>
		<cac:TaxCategory>
			<cbc:ID>{{ allowance.tax_category }}</cbc:ID>
			<cbc:Percent>{{ allowance.tax_rate }}</cbc:Percent>
			<cac:TaxScheme>
				<cbc:ID>VAT</cbc:ID>
			</cac:TaxScheme>
		</cac:TaxCategory>
	</cac:AllowanceCharge>
    {% endfor -%}
    <cac:TaxTotal>
        <cbc:TaxAmount currencyID="{{ data.currencyCode }}">{{ data.priceTax }}</cbc:TaxAmount>
        <cac:TaxSubtotal>
            <cbc:TaxableAmount currencyID="{{ data.currencyCode }}">{{ data.priceNet }}</cbc:TaxableAmount>
            <cbc:TaxAmount currencyID="{{ data.currencyCode }}">{{ data.priceTax }}</cbc:TaxAmount>
            {% if data.taxPercent != "" -%}
            <cac:TaxCategory>
                <cbc:ID>S</cbc:ID>
                <cbc:Percent>{{ data.taxPercent }}</cbc:Percent>
                <cac:TaxScheme>
                    <cbc:ID>VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:TaxCategory>
            {% endif -%}
        </cac:TaxSubtotal>
    </cac:TaxTotal>
    <cac:LegalMonetaryTotal>
        <cbc:LineExtensionAmount currencyID="{{ data.currencyCode }}">{{ data.priceNet }}</cbc:LineExtensionAmount>
        <cbc:TaxExclusiveAmount currencyID="{{ data.currencyCode }}">{{ data.priceNet }}</cbc:TaxExclusiveAmount>
        <cbc:TaxInclusiveAmount currencyID="{{ data.currencyCode }}">{{ data.priceFull }}</cbc:TaxInclusiveAmount>
        <cbc:PayableAmount currencyID="{{ data.currencyCode }}">{{ data.priceFull }}</cbc:PayableAmount>
    </cac:LegalMonetaryTotal>
    {%- for item in data.items %}
    <cac:InvoiceLine>
        <cbc:ID>{{ item.lineID }}</cbc:ID>
        <cbc:InvoicedQuantity unitCode="XPP">{{ item.quantity }}</cbc:InvoicedQuantity>
        <cbc:LineExtensionAmount currencyID="{{ data.currencyCode }}">{{ item.deliveryDetails }}</cbc:LineExtensionAmount>
        {% if item.periodStart != "" and item.periodEnd != "" -%}
        <cac:InvoicePeriod>
            <cbc:StartDate>{{ item.periodStart }}</cbc:StartDate>
            <cbc:EndDate>{{ item.periodEnd }}</cbc:EndDate>
        </cac:InvoicePeriod>
        {% endif -%}
        <cac:Item>
            <cbc:Description>{{ item.positionName }}</cbc:Description>
            <cbc:Name>{{ item.positionName }}</cbc:Name>
            <cac:SellersItemIdentification>
                <cbc:ID>{{ item.lineID }}</cbc:ID>
            </cac:SellersItemIdentification>
            <cac:ClassifiedTaxCategory>
                <cbc:ID>{{ item.taxCategory }}</cbc:ID>
                <cbc:Percent>{{ item.taxPercent }}</cbc:Percent>
                <cac:TaxScheme>
                    <cbc:ID>VAT</cbc:ID>
                </cac:TaxScheme>
            </cac:ClassifiedTaxCategory>
        </cac:Item>
        <cac:Price>
            <cbc:PriceAmount currencyID="{{ data.currencyCode }}">{{ item.priceNet }}</cbc:PriceAmount>
        </cac:Price>
    </cac:InvoiceLine>
    {%- endfor %}
</ubl:Invoice>
